<html>
	<head>
		<title>EDP platform</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<script src="js/jquery.min.js"></script>
		<link href="style/css/bootstrap-toggle.min.css" rel="stylesheet">
		<link href="style/css/bootstrap.min.css" rel="stylesheet">
		<link href="style/style-history.css" rel="stylesheet">
		<script src="style/js/bootstrap-toggle.min.js"></script>

	</head>

	<body>
		<script>
			function loadDoc(content, cFunction) {
				var xhttp;
				xhttp=new XMLHttpRequest();
				xhttp.onreadystatechange = function() {
					if (this.readyState == 4 && this.status == 200) {
						cFunction(this);
					}
				};
				xhttp.open("GET", "http://85.247.219.175:4567/api/" + content, true);
				xhttp.send();
			}

			function getTransactions (xhttp) {
				localStorage.setItem("transactions", xhttp.responseText);
			}
			function getEnergy (xhttp) {
				localStorage.setItem("energies", xhttp.responseText);
			}

			var customerID, transactions, energies;

			window.onload = function(){
				customerID = localStorage.getItem("customerIDStorage");
				loadDoc('transactions', getTransactions);
				loadDoc('energies', getEnergy);
			}

			function getStuff(){
				energies = localStorage.getItem("energies");
				transactions = localStorage.getItem("transactions");
				console.log(energies);
				console.log(transactions);
				energies = jQuery.parseJSON(energies);
				transactions = jQuery.parseJSON(transactions);
				setTimeout(function () {
				        parseData();
				    }, 1000);
			}

			function execute(){
				energies = localStorage.getItem("energies");
				transactions = localStorage.getItem("transactions");
				if(energies!=null && transactions!=null){
					getStuff();
				}else{
					setTimeout(function () {
				        execute();
				    }, 1);
				}
			}
			execute();

		</script>

		<div class="top-bar">

			<div class="settings">
					<button id="backButton" type="button" class="btn btn-default" aria-label="Left Align">
						<span class="glyphicon glyphicon-menu-left" aria-hidden="true" style="height: 20px; font-size:20; "></span>
					</button>
					<script>
						$("#backButton").on("click", function(){
							location.href = "menu.html";
						})
				    </script>
			</div>

				<div class="title">History</div>

			<div class="buttons">
					<button id="homeButton" type="button" class="btn btn-default" aria-label="Left Align">
						<span class="glyphicon glyphicon-home" aria-hidden="true" style="height: 20px; font-size:20; "></span>
					</button>
					<script>
						$("#homeButton").on("click", function(){
							location.href = "menu.html";
						})
				    </script>
			</div>

		</div>
		<div style="clear:both;width:100%;height:10px;"></div>
		<div class="balance2">
				<div class="panel panel-default" style="margin-top:30px;">
					<div class="headingText">SOLD</div>
					<table id="soldTable" class="table table-striped" style="margin-top:10px;">
						<tr></tr>

					</table>
					<br>
				</div>
				<script>
					function parseData() {
						var count = 1;
						var quantity, price, date;
						transactions.forEach(function(d){
							energies.forEach(function(i){
								if(d.energy_id==i.energy_id){
									if(i.producer_id==customerID){
										quantity=i.quantity;
										price = i.KWhPrice*quantity;
										date = new Date(d.transaction_time);
										var day = date.getDate();
										if(day<10) day = '0' + day;
										var month = date.getMonth()+1;
										if(month<10) month = '0' + month;
										var year = date.getFullYear();
										date = day+"-"+month+"-"+year;

										$("#soldTable").append('<tr><td class="lbl5">' + count + '.</td><td class="lbl5">' + quantity + ' kW</td><td class="lbl5">' + price + ' €</td><td class="lbl5">' + day + '-' + month + '-' + year + '</td></tr>');
										count ++;
									}
								}
							})
						})
						parseData2();
					}

				</script>
		</div>
		<div class="balance2">
			<div class="panel panel-default" style="margin-top:30px;">
				<div class="headingText">BOUGHT</div>
				<table  id="boughtTable" class="table table-striped" style="margin-top:10px;">
					<tr></tr>

				</table>
				<br>
			</div>
				<script>
					function parseData2() {
						var count = 1;
						var quantity, price, date;
						transactions.forEach(function(d){
							if(d.client_id == customerID){
								energies.forEach(function(i){
									if(d.energy_id==i.energy_id){
										quantity=i.quantity;
										price = i.KWhPrice*quantity;
										date = new Date(d.transaction_time);
										var day = date.getDate();
										if(day<10) day = '0' + day;
										var month = date.getMonth()+1;
										if(month<10) month = '0' + month;
										var year = date.getFullYear();
										date = day+"-"+month+"-"+year;
										$("#boughtTable").append('<tr><td class="lbl5">' + count + '.</td><td class="lbl5">' + quantity + ' kW</td><td class="lbl5">' + price + ' €</td><td class="lbl5">' + day + '-' + month + '-' + year + '</td></tr>');
										count ++;
									}
								})
							}
						})
					}
				</script>
			</div>
			<div class="footer2">
			<label class="lbl4" style="margin-top:3px;">Help</label>
			<label class="lbl4" style="margin-left:5px;margin-top:3px;">Contact</label>
			<label class="lbl4" style="margin-left:5px;margin-top:3px;">T&C</label>
		</div>
</html>
