<html>

	<head>
		<title>EDP platform</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<script src="js/jquery.min.js"></script>
		<link href="style/css/bootstrap-toggle.min.css" rel="stylesheet">
		<link href="style/css/bootstrap.min.css" rel="stylesheet">
		<link href="style/style-sell.css" rel="stylesheet">
		<link href="style/checkbox.css" rel="stylesheet">
		<script src="style/js/bootstrap-toggle.min.js"></script>
		<script>



			function sleep(milliseconds) {
			  var start = new Date().getTime();
			  for (;;) {
			    if ((new Date().getTime() - start) > milliseconds){
			      break;
			    }
			  }
			}



			function loadDoc(content, cFunction) {
				var xhttp;
				xhttp=new XMLHttpRequest();
				xhttp.onreadystatechange = function() {
					if (this.readyState == 4 && this.status == 200) {
						cFunction(this);
					}
				};

				xhttp.open("GET", 'http://85.247.219.175:4567/api/' + content, true);
				xhttp.send();
			}									


			function getEnergy (xhttp) {
				localStorage.setItem("energies", xhttp.responseText);
			}

			function getTransactions (xhttp) {
				localStorage.setItem("transactions", xhttp.responseText);
			}

			
			var energies, lastIDEnergy, customerID, transactions;

			window.onload = function(){
				customerID = localStorage.getItem("customerIDStorage");
				loadDoc('energies?filter=%7B%22where%22%3A%7B%22producer_id%22%3A' + customerID + '%7D%7D', getEnergy);
				loadDoc('transactions', getTransactions);
			}

			function getStuff(){
				energies = localStorage.getItem("energies");
				transactions = localStorage.getItem("transactions");
				console.log(energies);
				console.log(transactions);
				energies = jQuery.parseJSON(energies);
				transactions = jQuery.parseJSON(transactions);
				lastIDEnergy = energies[energies.length-1].energy_id;
				setTimeout(function () {
				        parseData();
				    }, 250);
			}


			function waitForElement(){
				$('#loading').show();
				energies = localStorage.getItem("energies");
				transactions = localStorage.getItem("transactions");
			    if(energies!=null && transactions!=null){
			    	getStuff();
			    }
			    else{
			        setTimeout(waitForElement, 250);
			    }
			}
			waitForElement();


		</script>
	</head>

	<body>
		<script>

			$('body').click(function(e) {
			    if (!$(e.target).closest('.popupDiv').length){
			        $(".popupDiv").hide();
			        $("#popupDiv-back").hide();
			    }
			});

			function someFunc(value, price, quantity){
				$("#priceChange" + value).ready(function(){
					$("#popupDiv-back").delay( 100 ).fadeIn(100);
					$("#popupDiv-back").css("height", document.body.scrollHeight);
					$(".popupDiv").show(40);
					$(".popupDiv").css('top', $(document).scrollTop()+(screen.height/2));
					$(".oldPrice").html(price);
					$(".originalQty").html(quantity);
					$(".oldPriceInput").val(price);
					$(".id").val(value);
					$(".quantity").val(quantity);
					$(".amountEarn2").html($(".oldPriceInput").val()*$(".quantity").val());
				})
			}




		</script>
		<div id="popupDiv-back"></div>
		<div class="popupDiv">
		<div class="alert alert-danger errorAlert" role="alert" style="display:none;border-radius:10px;position:absolute;width:99%;top:1px;height:40px;left:50%;margin-left:-49.8%;z-index:9999">
		  <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true" style="position:relative;z-index:9999;top:-3px;"></span>
		  <span class="sr-only" style="position:relative;z-index:9999;top:-5px;font-size:12px;">&nbsp;</span>
		  <label class="error" style="position:relative;z-index:9999;top:-5px;font-size:11px;">An error ocurred. Please try again.</label>
		  <span class="glyphicon glyphicon-remove" aria-hidden="true" style="float:right;padding:0px;left:3px;"></span>
		</div>
		<div class="alert alert-success successAlert" role="alert" style="display:none;border-radius:10px;position:absolute;width:99%;top:1px;height:40px;left:50%;margin-left:-49.8%;z-index:9999">
		  <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true" style="position:relative;z-index:9999;top:-3px;"></span>
		  <span class="sr-only" style="position:relative;z-index:9999;top:-5px;font-size:12px;">Success:</span>
		  <label class="success" style="position:relative;z-index:9999;top:-5px;font-size:11px;">Changing to the new price</label>
		  <span class="glyphicon glyphicon-remove" aria-hidden="true" style="float:right;padding:0px;left:3px;"></span>
		</div>
			<div class="pricesBox">
				<br>
				<form name="formnew" method="post">
					<input type="hidden" class="id" name="id">
					<input type="hidden" class="quantity" name="quantity">
				<div class=changeBox>
					<div class="headingBox">
						<div class="stroke"></div>
						<div class="separator"></div>
						<div class="text">Change Price</div>
						<div class="separator"></div>
						<div class="stroke"></div>
					</div>
					<div style="width:100%;height:1px;clear:both;"></div>
					<table style="width:100%;position:relative;top:0px;">
						<tr>
							<td><span class="description">Selling:</span></td>
							<td><span class="description" style="font-size:0.9em;"><label class="originalQty"></label> kW</span></td>
						</tr>
						<tr>
							<td><span class="description">Current Price:</span></td>
							<td><span class="description" style="font-size:0.9em;"><label class="oldPrice"></label> €/kW</span></td>
						</tr>
					<div style="margin-top:10px">
						<tr>
							<td><label class="description">New Price: </label></td>
							<td align="center">
								<input class="box oldPriceInput" name="newPrice" type="number" step="1" value="0" min="0" style="font-size:0.9em;border-radius:5px;border:1px solid #333;text-align:center;width: 60px; position:relative;top:-10px;">
							</td>
						</tr>
					</table>
						<label class="description earn2" style="font-size:0.8em;position:relative;left:0px;color:#333;top:-10px;opacity:0.9;">You will earn: <font class="amountEarn2">_</font> €</span>	
					</div>
<script>
				$(document).ready(function(){
					$(".oldPriceInput").val($(".oldPrice").val());
				})
				$( ".oldPriceInput " ).change(function() {
			  		$(".earn2").css("visibility", "visible");
			  		$(".amountEarn2").html($(".oldPriceInput").val()*$(".quantity").val());
				});
				$( ".oldPriceInput " ).click(function() {
			  		$(".earn2").css("visibility", "visible");
			  		$(".amountEarn2").html($(".oldPriceInput").val()*$(".quantity").val());
				});
				$( ".oldPriceInput " ).keyup(function() {
			  		$(".earn2").css("visibility", "visible");
			  		$(".amountEarn2").html($(".oldPriceInput").val()*$(".quantity").val());
				});
			</script>

				</div>
				<div class="confirm" style="margin-top:-20px;">
						<button id="formSellupdate" type="submit" class="btn btn-danger" style="width:150px;">Confirm</button>
				</div>
				</form>
				<script>
					$("#formSellupdate").on("click",function(e) {
						$(".successAlert").fadeIn();
					    e.preventDefault(); // cancel submission
					    var price = document.forms["formnew"]["newPrice"].value;
						var id = document.forms["formnew"]["id"].value;
						var quantity = document.forms["formnew"]["quantity"].value;
					    if( quantity != "" && price != "" ){

					    	var xhr = new XMLHttpRequest();
									xhr.open('DELETE', 'http://85.247.219.175:4567/api/energies/' + id , true);
									xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
									xhr.onload = function () {
									    console.log(this.responseText);
									};
									xhr.send(null);


								var energy = JSON.stringify({ KWhPrice: parseInt(price),
																							active: 1,
																							energy_id: id,
																							holder: 40,
																							packDescript: "hello",
																							packName: "hello",
																							percentage: 100,
																							posted_time: new Date(),
																							producer_id: customerID,
																							quantity: quantity });

								console.log(energy);
								setTimeout(function(){
								var xhr = new XMLHttpRequest();
								xhr.open('POST', 'http://85.247.219.175:4567/api/energies' , true);
								xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
								xhr.onload = function () {
								    console.log(this.responseText);
								};
								xhr.addEventListener('error', function(e) {
							      $(".errorAlert").fadeIn();
							    });
								xhr.addEventListener('loadend', function(e) {

									console.log("GOING");
									loadDoc('energies', getEnergy);
									setTimeout(function(){
									    window.location = "sellEnergy.html";
									}, 500);
							    });
								xhr.send(energy);
								}, 500);
					    }
					});
				</script>
			</div>
		</div>
		<div class="top-bar">
		<div class="settings">
				<a href="./menu.html">
				<button type="button" class="btn btn-default" aria-label="Left Align">
					<span class="glyphicon glyphicon-menu-left" aria-hidden="true" style="height: 20px; font-size:20; "></span>
				</button>
				</a>
			</div>

			<div class="title">Sell Energy</div>

			<div class="buttons">
				<a href="./menu.html">
				<button type="button" class="btn btn-default" aria-label="Left Align">
					<span class="glyphicon glyphicon-home" aria-hidden="true" style="height: 20px; font-size:20; "></span>
				</button>
				</a>
			</div>

		</div>

		<div class="balance2">
			<div class="panel panel-default">
				<table style="margin-left:10px;margin:10px;">
					<tr>
						<th class="firstRow" style=""></th>
						<th style="width:90px;"></th>
						<th></th>
					</tr>
					<tr>
						<td class="lbl4" >Average Price Today: </td>
						<td class="lbl4" style="text-align:center;">1 €/Kw</td>
						<td style="text-align:right;">
							<button type="button" class="btn btn-danger" style="margin-top: 0px;margin-left: 0%;height:30px;width:100px;">
								<label class="lbl4" style="position:relative;top:0px;left:-4px;">Check Market</label>
							</button>
						</td>
					</tr>
					<tr style="font-size:0.5em;">
						<td>&nbsp;</td>
						<td>&nbsp;</td>
						<td>&nbsp;</td>
					</tr>
					<tr>
						<td class="lbl4">Available Energy: </td>
						<td class="lbl4" style="text-align:center;">35 Kw</td>
						<td style="text-align:right;">
							<button type="button" class="btn btn-danger" style="margin-top: 0px;margin-left: 0%;height:30px;width:100px;">
								<label class="lbl4" style="position:relative;top:0px;left:0px;">My Balance</label>
							</button>
						</td>
					</tr>
				</table>
			</div>
			<div class="panel panel-default" style="margin-top:-10px;">
				<form name="myForm" method="post">
					<div class="panel-body">Amount
				  		<div class="input-group" style="width: 40%; float: right;">
					  		<input type="text" name="quantity" class="form-control kW">
					  		<span class="input-group-addon"  style="font-size:.6em;width:10px;max-width:10px;"><font style="position:relative;left:-3px;">kW</font></span>
						</div>
					</div>
				  	<div class="panel-body">Price <label class="lbl4" style="color:#333;font-size:0.6em"> (per kW)</label>
				  		<div class="input-group" style="width: 40%; float: right;">
					  		<input type="text" name="price" class="form-control euros">
					 		<span class="input-group-addon">€</span>
						</div>
					</div>
					<span class="earn" style="font-size:.9em;position:relative;left:15px;color:#333;top:-15px;opacity:0.9;visibility:hidden;">You will earn: <font class="amountEarn">_</font> €</span>
					<div style="clear:both;"></div>
					<button id="formSell" type="submit" value="submit" class="btn btn-danger buttonRow" style="position:relative;top: 5px;height:30px;margin-left:-30px;left:50%;width:60px;">
							<label class="lbl3" style="position:relative;top:-2px;left:-2px;">Sell</label>
					</button>
				</form>
				<div style="width:100%;height:10px;clear:both;"></div>
			</div>
			<script>
				$(document).ready(function(){
					$(".euros").val("");
					$(".kW").val("");
				})
				$( ".kW " ).change(function() {
					if($(".euros").val()==1 || $(".euros").val()==0){
			  			$(".euros").val(1);
			  		}
			  		$(".earn").css("visibility", "visible");
			  		$(".amountEarn").html($(".euros").val()*$(".kW").val());
				});
				$( ".kW " ).click(function() {
					if($(".euros").val()==1 || $(".euros").val()==0){
			  			$(".euros").val(1);
			  		}
			  		$(".earn").css("visibility", "visible");
			  		$(".amountEarn").html($(".euros").val()*$(".kW").val());
				});
				$( ".kW " ).keyup(function() {
					if($(".euros").val()==1 || $(".euros").val()==0){
			  			$(".euros").val(1);
			  		}
			  		$(".earn").css("visibility", "visible");
			  		$(".amountEarn").html($(".euros").val()*$(".kW").val());
				});
				$( ".euros " ).change(function() {
			  		$(".earn").css("visibility", "visible");
			  		$(".amountEarn").html($(".euros").val()*$(".kW").val());
				});
				$( ".euros " ).click(function() {
			  		$(".earn").css("visibility", "visible");
			  		$(".amountEarn").html($(".euros").val()*$(".kW").val());
				});
				$( ".euros " ).keyup(function() {
			  		$(".earn").css("visibility", "visible");
			  		$(".amountEarn").html($(".euros").val()*$(".kW").val());
				});
			</script>

			<script>
					$("#formSell").on("click",function(e) {
					    e.preventDefault(); // cancel submission
					    var quantity = document.forms["myForm"]["quantity"].value;
					    var price = document.forms["myForm"]["price"].value;
					    if( quantity != "" && price != "" ){

								var energy = JSON.stringify({ KWhPrice: parseInt(price),
																							active: 1,
																							energy_id: 0,
																							holder: 40,
																							packDescript: "hello",
																							packName: "hello",
																							percentage: 100,
																							posted_time: new Date(),
																							producer_id: customerID,
																							quantity: quantity });

								console.log(energy);

								var xhr = new XMLHttpRequest();
								xhr.open('POST', 'http://85.247.219.175:4567/api/energies' , true);
								xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
								xhr.onload = function () {
								    console.log(this.responseText);
								};
								xhr.addEventListener('loadend', function(e) {
									console.log("GOING");
									loadDoc('energies', getEnergy);
									setTimeout(function(){
									    window.location = "sellEnergy.html";
									}, 500);
							    });
								xhr.send(energy);
					    }
					});
				</script>


			<div class="panel panel-default" style="margin-top:-10px;">
				<div class="sellTitle">Currently selling:</div>
				<img id="loading" src="images/loading.gif" width="200" style="display:none;position:relative;left:50%;margin-left:-100px;"/>
				<table id="currentlySelling" class="table table-striped" style="margin-top:10px;">
					<tr>
						<td class="lbl5" style="color:#8a8a8a;">Name</td>
						<td class="lbl5" style="color:#8a8a8a;">kW</td>
						<td class="lbl5" style="color:#8a8a8a;">€</td>
						<td class="lbl5" style="color:#8a8a8a;">Date</td>
						<td class="lbl5" style="color:#8a8a8a;">Options</td>
					</tr>
				</table>
				<br>
			</div>
			<script>

				function parseData() {
					top:for(i=0;i<energies.length;i++){	
						for(t=0;t<transactions.length;t++){	
							if(energies[i].energy_id==transactions[t].energy_id){		
								continue top;
							}
					    }

					    var date = new Date(energies[i].posted_time);
						var day = date.getDate();
						if(day<10) day = '0' + day;
						var month = date.getMonth()+1;
						if(month<10) month = '0' + month;
						var year = date.getFullYear();
						date = day+"-"+month+"-"+year;

					   $("#currentlySelling").append('<tr><td class="lbl5">' + energies[i].packName + '</td><td class="lbl5">' + energies[i].quantity + '</td><td class="lbl5">' + energies[i].KWhPrice + '</td><td class="lbl5" style="font-size:0.6em">' + date + '</td><td align="right"><button type="button" id="priceChange' + energies[i].energy_id + '" onclick="someFunc(' + energies[i].energy_id + ',' + energies[i].KWhPrice + ',' + energies[i].quantity + ')" class="btn btn-danger" style="height:25px;width:55px;"><label class="lbl7" style="position:relative;top:0px;left:-5px;"><span class="glyphicon glyphicon-pencil" style="margin-right:5px;aria-hidden="true"></span>Price</label></button></td>' + /* '<button type="button" class="btn btn-default" aria-label="Left Align" style="float:right;background-color:#d9534f;"><span class="glyphicon glyphicon-trash" aria-hidden="true" style="height: 17px; font-size:15; color:white;"></span></button>'  +*/ '</tr>');
					   $('#loading').hide();

					}
				}
			</script>
		</div>
		<div class="heightspace"></div>
		<div class="footer2">
			<label class="lbl4" style="margin-top:3px;">Help</label>
			<label class="lbl4" style="margin-left:5px;margin-top:3px;">Contact</label>
			<label class="lbl4" style="margin-left:5px;margin-top:3px;">T&C</label>
		</div>

	</body>

</html>
